## 操作幂等性

### 幂等性的定义

幂等性是指用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。一个简单的例子是在线支付。用户购买商品时支付货款，支付扣款成功，若返回结果的时候网络异常，此时钱已经扣除，用户再次点击支付按钮会导致再次扣款，返回结果成功，用户查询余额返发现多扣钱了，流水记录也变成了两条。

### 确定需要幂等性的范围

1. 确定大致范围
   
   请求层面：读请求、写请求。其中读请求没有影响数据变化不需要幂等性。
   微服务层面：负载均衡、api网关、业务逻辑层、数据访问层。其中负载均衡、api网关、业务逻辑层没有影响数据变化不需要幂等性。
   总结：以上只有数据访问层和写请求需要幂等性。

2. 数据访问层‐写请求
   
   Insert：需要幂等性。
   
   Update：直接更新某个值，不需要幂等性；累加操作等计算式的更新，需要幂等性。
   
   Delete：重复删除结果是一样，不需要幂等性。

### 幂等性解决方案

最适合的幂等性解决方案与业务的逻辑强相关。一个通用方案的例子如下。

1. Insert幂等方案
   
   a) 数据字段增加唯一索引
   
   优点：实现简单方便。
   
   缺点：影响数据库性能，不适合该字段会被频繁更新的场景，唯一索引比普通索引在写操作上开销会大很多。
   
   b) insert时使用临时表查询判断
   
   ```
   insert into sys_user(name,password)
   
   select 'admin', '123456' from dual
   
   where not exists(select 1 from sys_user where name='admin');
   
   优点：不需要创建唯一索引，语法相对通用（MySQL和Oracle）。
   
   缺点：写操作会增加一次select子查询开销，增加sql语法的复杂度可读性较差。
   ```

       c) 细粒度分布式锁 + select + insert

       原理是先加一个细粒度的分布式锁，然后select查一下是否存在，不存在再insert

       优点：性能影响较少，使用的是细粒度锁，所以只有重复提交记录时才会阻塞。

       缺点：写操作会增加一次select开销，实现难度相对较大因为需要分布式细粒度     锁。

2. Update计算操作幂等方案
   
   需要结合具体业务来设计方案，常用的场景可通过版本号的方式来控制。
   
   a) 在表里面添加version字段
   
        alter table sys_user add version int default 0;
   
   b) 然后更新的时候通过这个version来判断是否为过期无效操作，这是乐观锁的一种思路.
   
       update sys_user set age=age+1, version=version+1 where version=xx


